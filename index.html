<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Smart Stream Player (TV & Mobile Friendly)</title>

  <link href="https://amp.azure.net/libs/amp/latest/azuremediaplayer.min.css" rel="stylesheet">
  <script src="https://amp.azure.net/libs/amp/latest/azuremediaplayer.min.js"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, sans-serif;
      background: #0b1220;
      color: white;
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 32px 24px;
    }

    .app {
      width: min(960px, 100%);
      background: #101a2b;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
      padding: 28px 28px 32px;
    }

    h2 {
      text-align: center;
      margin: 0 0 20px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .channel-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(88px, 1fr));
      gap: 14px;
      margin-bottom: 18px;
    }

    .channel-btn {
      appearance: none;
      border: none;
      background: #1b2a41;
      color: inherit;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 10px;
      min-height: 120px;
      font-size: 13px;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s, box-shadow 0.2s, color 0.2s;
      touch-action: manipulation;
      width: 100%;
    }

    .channel-btn img {
      width: 64px;
      height: 64px;
      object-fit: contain;
      border-radius: 6px;
    }

    .channel-btn span {
      display: block;
      line-height: 1.3;
      text-align: center;
    }

    .channel-btn:hover,
    .channel-btn.focused {
      background: #06b6d4;
      color: #001018;
      transform: scale(1.04);
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.35);
    }

    .channel-btn:active {
      transform: scale(0.97);
    }

    .channel-btn:focus-visible {
      outline: 3px solid #00c8ff;
      outline-offset: 3px;
    }

    video,
    .azuremediaplayer {
      width: 100%;
      border-radius: 10px;
      background: black;
      margin-top: 14px;
      max-height: 60vh;
    }

    .hidden {
      display: none;
    }

    .status {
      margin-top: 14px;
      font-size: 14px;
      color: #a3b3c4;
      text-align: center;
    }

    @media (max-width: 900px) {
      body {
        padding: 24px 16px;
        align-items: flex-start;
      }

      .app {
        padding: 22px 20px 28px;
      }

      .channel-buttons {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 12px;
      }
    }

    @media (max-width: 520px) {
      body {
        padding: 18px 12px;
      }

      .channel-buttons {
        grid-template-columns: repeat(auto-fit, minmax(72px, 1fr));
        gap: 10px;
      }

      .channel-btn {
        padding: 10px 8px;
        min-height: 110px;
        font-size: 12px;
      }

      .channel-btn img {
        width: 52px;
        height: 52px;
      }

      .status {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h2>Smart Stream Player</h2>

    <div class="channel-buttons" id="channelButtons"></div>

    <video id="videoElement" class="hidden" controls playsinline></video>
    <video id="azureVideo" class="azuremediaplayer hidden" controls playsinline></video>

    <div class="status" id="status" aria-live="polite">Status: idle</div>
  </div>

  <script>
    const channelButtons = document.getElementById('channelButtons');
    const video = document.getElementById('videoElement');
    const azureVideo = document.getElementById('azureVideo');
    const statusEl = document.getElementById('status');

    let dashPlayer = null;
    let hlsPlayer = null;
    let ampPlayer = null;

    let focusedIndex = 0;
    const btns = [];

    function setStatus(txt) {
      statusEl.textContent = 'Status: ' + txt;
    }

    function stopAll() {
      if (dashPlayer) {
        dashPlayer.reset();
        dashPlayer = null;
      }
      if (hlsPlayer) {
        hlsPlayer.destroy();
        hlsPlayer = null;
      }
      if (ampPlayer) {
        try {
          ampPlayer.dispose();
        } catch (e) {
          console.error(e);
        }
        ampPlayer = null;
      }

      [video, azureVideo].forEach((element) => {
        element.pause();
        element.removeAttribute('src');
        element.load();
        element.classList.add('hidden');
      });

      setStatus('idle');
    }

    async function fetchStreamUrl(apiUrl) {
      try {
        const res = await fetch(apiUrl);
        const json = await res.json();
        if (json?.streams) {
          return json.streams.hls || json.streams.mpd || json.streams.smooth;
        }
      } catch (e) {
        console.error(e);
      }
      return null;
    }

    function detectType(url) {
      const u = url.toLowerCase();
      if (u.includes('.m3u8')) return 'hls';
      if (u.includes('.mpd')) return 'mpd';
      if (u.includes('.ism') || u.includes('.isml')) return 'isml';
      return null;
    }

    async function playUrl(url) {
      stopAll();
      setStatus('Loading...');

      if (url.includes('/api/')) {
        setStatus('Fetching APIâ€¦');
        const fetched = await fetchStreamUrl(url);
        if (!fetched) {
          setStatus('Failed to fetch stream.');
          return;
        }
        url = fetched;
        setStatus('Found stream: ' + url);
      }

      const type = detectType(url);
      if (!type) {
        setStatus('Unknown stream type');
        return;
      }

      let activeElement = video;

      if (type === 'hls') {
        video.classList.remove('hidden');
        if (Hls.isSupported()) {
          hlsPlayer = new Hls();
          hlsPlayer.loadSource(url);
          hlsPlayer.attachMedia(video);
          hlsPlayer.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = url;
          video.play();
        }
      }

      if (type === 'mpd') {
        video.classList.remove('hidden');
        dashPlayer = dashjs.MediaPlayer().create();
        dashPlayer.initialize(video, url, true);
      }

      if (type === 'isml') {
        azureVideo.classList.remove('hidden');
        activeElement = azureVideo;
        ampPlayer = amp(azureVideo, { autoplay: true }, function () {
          this.src([{ src: url, type: 'application/vnd.ms-sstr+xml' }]);
        });
      }

      try {
        if (activeElement && !activeElement.classList.contains('hidden')) {
          if (activeElement.requestFullscreen) {
            activeElement.requestFullscreen();
          } else if (activeElement.webkitRequestFullscreen) {
            activeElement.webkitRequestFullscreen();
          } else if (activeElement.msRequestFullscreen) {
            activeElement.msRequestFullscreen();
          }
        }
      } catch (e) {
        console.log(e);
      }

      setStatus('Playing stream');
    }

    function setFocus(newIndex, options = {}) {
      if (!btns.length) return;

      const { scroll = true, skipProgrammaticFocus = false } = options;
      focusedIndex = (newIndex + btns.length) % btns.length;

      btns.forEach((btn, idx) => {
        btn.classList.toggle('focused', idx === focusedIndex);
      });

      const target = btns[focusedIndex];
      if (!target) return;

      if (!skipProgrammaticFocus && document.activeElement !== target) {
        try {
          target.focus({ preventScroll: true });
        } catch (e) {
          target.focus();
        }
      }

      if (scroll) {
        try {
          target.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        } catch (e) {
          target.scrollIntoView();
        }
      }
    }

    function findNearest(direction) {
      const current = btns[focusedIndex];
      if (!current) return focusedIndex;

      const currentRect = current.getBoundingClientRect();
      const currentCenterX = currentRect.left + currentRect.width / 2;
      const currentCenterY = currentRect.top + currentRect.height / 2;

      let candidate = focusedIndex;
      let candidateDistance = Infinity;
      const threshold = 6;

      btns.forEach((btn, idx) => {
        if (idx === focusedIndex) return;
        const rect = btn.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        if (direction === 'up' && rect.bottom <= currentRect.top - threshold) {
          const distance = Math.hypot(centerX - currentCenterX, currentRect.top - rect.bottom);
          if (distance < candidateDistance) {
            candidateDistance = distance;
            candidate = idx;
          }
        } else if (direction === 'down' && rect.top >= currentRect.bottom + threshold) {
          const distance = Math.hypot(centerX - currentCenterX, rect.top - currentRect.bottom);
          if (distance < candidateDistance) {
            candidateDistance = distance;
            candidate = idx;
          }
        }
      });

      return candidate;
    }

    const channels = [
      { name: 'SBC', logo: 'https://aloula.faulio.com/storage/mediagallery/79/c6/fullhd_946269c528b9c02926a56044d8220afd574b31f7.png', api: 'https://aloula.faulio.com/api/v1.1/channels/1/player' },
      { name: 'Saudi TV 1', logo: 'https://i.imgur.com/GRQTndk.png', api: 'https://aloula.faulio.com/api/v1.1/channels/2/player' },
      { name: 'Thikrayat TV', logo: 'https://media0087.elcinema.com/tvguide/1366_1.png', api: 'https://aloula.faulio.com/api/v1.1/channels/3/player' },
      { name: 'Alekhbariya', logo: 'https://aloula.faulio.com/storage/mediagallery/11/78/fullhd_3b55efbef523c3a6d6e45d8c5a2d28b86bdf4117.png', api: 'https://aloula.faulio.com/api/v1.1/channels/4/player' },
      { name: 'Sunnah', logo: 'https://aloula.faulio.com/storage/mediagallery/33/92/fullhd_879e557011826f507a045b4e0b4c3b57ba93edae.png', api: 'https://aloula.faulio.com/api/v1.1/channels/6/player' },
      { name: 'Quran', logo: 'https://aloula.faulio.com/storage/mediagallery/da/6c/fullhd_7eaf7e165c4cad5b3a45eff65d2011e18be5d670.png', api: 'https://aloula.faulio.com/api/v1.1/channels/7/player' },
      { name: 'KSA Sports 1', logo: 'https://aloula.faulio.com/storage/mediagallery/36/f0/fullhd_7b5a1c62d4c0785dff72d85e41ade22b9478258b.png', api: 'https://aloula.faulio.com/api/v1.1/channels/9/player' },
      { name: 'KSA Sports 2', logo: 'https://aloula.faulio.com/storage/mediagallery/57/09/fullhd_470ef56d4e496e82df1d74aca7edeef597b2e541.png', api: 'https://aloula.faulio.com/api/v1.1/channels/10/player' },
      { name: 'Saudia Radio', logo: 'https://aloula.faulio.com/storage/mediagallery/5b/98/fullhd_da335fc25afb1da620b54d6464dcf43738984d0e.png', api: 'https://aloula.faulio.com/api/v1.1/channels/11/player' },
      { name: 'Riyadh Radio', logo: 'https://aloula.faulio.com/storage/mediagallery/37/1a/fullhd_399eddcc4305f34f41c7fab24c3518fab5d55d97.png', api: 'https://aloula.faulio.com/api/v1.1/channels/12/player' },
      { name: 'Quran Radio', logo: 'https://aloula.faulio.com/storage/mediagallery/14/da/fullhd_823bc2fe722ede75410492d57fd6c201208b4224.png', api: 'https://aloula.faulio.com/api/v1.1/channels/13/player' },
      { name: 'Nida Alislam', logo: 'https://aloula.faulio.com/storage/mediagallery/0f/c5/fullhd_5da380cdfc304fd7d4672a83aeb6c62bc1d3d3e8.png', api: 'https://aloula.faulio.com/api/v1.1/channels/14/player' },
      { name: 'Jeddah Radio', logo: 'https://aloula.faulio.com/storage/mediagallery/bd/f5/fullhd_527bf54a5adb56ac17f572ac2cd0801304db3baf.png', api: 'https://aloula.faulio.com/api/v1.1/channels/15/player' },
      { name: 'KSA Sport 3', logo: 'https://aloula.faulio.com/storage/mediagallery/2d/ee/fullhd_f1d461237592b4d46c44a6f300df1d97051f7c55.png', api: 'https://aloula.faulio.com/api/v1.1/channels/16/player' },
      { name: 'KSA Now', logo: 'https://aloula.faulio.com/storage/mediagallery/47/4f/fullhd_64167a679b7b2b43aa0e9549a920b50dc01cd531.png', api: 'https://aloula.faulio.com/api/v1.1/channels/17/player' },
      { name: 'Khuzama Radio', logo: 'https://aloula.faulio.com/storage/mediagallery/7b/ba/fullhd_e6cc7306ef5148f1d32923048e70a3f827a51e75.png', api: 'https://aloula.faulio.com/api/v1.1/channels/18/player' }
    ];

    channels.forEach((ch, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'channel-btn';
      btn.innerHTML = `<img src="${ch.logo}" alt="${ch.name} logo"><span>${ch.name}</span>`;
      btn.setAttribute('aria-label', `${ch.name} channel`);
      btn.addEventListener('click', () => {
        setFocus(i, { scroll: false });
        playUrl(ch.api);
      });
      btn.addEventListener('pointerdown', () => {
        setFocus(i, { scroll: false });
      });
      btn.addEventListener('focus', () => {
        setFocus(i, { scroll: false, skipProgrammaticFocus: true });
      });
      channelButtons.appendChild(btn);
      btns.push(btn);
    });

    if (btns.length) {
      setFocus(0, { scroll: false });
    }

    document.addEventListener('keydown', (e) => {
      const len = btns.length;
      if (!len) return;

      switch (e.key) {
        case 'ArrowRight':
          setFocus(focusedIndex + 1);
          e.preventDefault();
          break;
        case 'ArrowLeft':
          setFocus(focusedIndex - 1);
          e.preventDefault();
          break;
        case 'ArrowUp': {
          const nextUp = findNearest('up');
          if (nextUp !== focusedIndex) {
            setFocus(nextUp);
            e.preventDefault();
          }
          break;
        }
        case 'ArrowDown': {
          const nextDown = findNearest('down');
          if (nextDown !== focusedIndex) {
            setFocus(nextDown);
            e.preventDefault();
          }
          break;
        }
        case 'Enter':
        case 'Select':
        case ' ':
        case 'Spacebar':
        case 'Space':
        case 'MediaPlayPause':
          btns[focusedIndex].click();
          e.preventDefault();
          break;
        case 'Backspace':
        case 'Escape':
        case 'MediaStop':
          stopAll();
          setFocus(focusedIndex, { scroll: false });
          e.preventDefault();
          break;
        default:
          break;
      }
    });
  </script>
</body>
</html>